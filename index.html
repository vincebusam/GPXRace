<!DOCTYPE HTML>
<html>
<head>
<title>GPX Compare</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<style>
#slider {width: 50%;}
</style>
<script>
var tracks = [];
var files = 0;
var filesread = 0;

// Haversine
// http://stackoverflow.com/questions/5260423/torad-javascript-function-throwing-error
function distance(lat1, lon1, lat2, lon2) {
  var R = 6371; // Radius of the earth in km
  var dLat = (lat2 - lat1) * Math.PI / 180;  // deg2rad below
  var dLon = (lon2 - lon1) * Math.PI / 180;
  var a = 
     0.5 - Math.cos(dLat)/2 + 
     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
     (1 - Math.cos(dLon))/2;

  return R * 2 * Math.asin(Math.sqrt(a));
}

function checkdone() {
  filesread += 1;
  if (filesread < files)
    return;
  $("#slider").slider({
    max: Math.max.apply(Math,tracks.map(function(d) { return d[d.length-1].ts; })),
    slide: function(e, ui) {
      $("#time").html(Math.floor((ui.value/(1000*60*60))/24)+":"+("0"+Math.floor((ui.value/(1000*60))%60)).slice(-2)+":"+("0"+Math.floor((ui.value/1000)%60)).slice(-2));
      $("#coords").html("");
      for (var i=0; i<tracks.length; i++) {
        var totdist = 0;
        for (var j=0; j<tracks[i].length; j++) {
          if (j>1)
            totdist += distance(tracks[i][j].lat,tracks[i][j].lon,tracks[i][j-1].lat,tracks[i][j-1].lon) * 0.621371; // Convert to miles
          if (tracks[i][j].ts >= ui.value || j==tracks[i].length-1) {
            if (j>0 && (Math.abs(tracks[i][j-1].ts-ui.value))<(Math.abs(tracks[i][i].ts-ui.value))) j -= 1;
            $("#coords").append(tracks[i][j].name + ": " + tracks[i][j].lat + "," + tracks[i][j].lon + " " + totdist.toFixed(2) + "mi<br>");
            break;
          }
        }
      }
    }
  });
  $("#data").show();
}

$(document).ready(function () {
  $("#data").hide();
  $("#load").click(function () {
    var gpxf = $("#gpxfiles")[0];
    if (gpxf.files == undefined || gpxf.length == 0)
      return;
    files = gpxf.length;
    filesread = 0;
    $.each(gpxf.files, function(i, f) {
      var reader = new FileReader();
      var fname = f.name;
      reader.onload = function(event) {
        var gpx = $.parseXML(event.target.result);
        var starttime = new Date($(gpx).find("trkseg").eq(0).children().eq(0).find("time").text());
        var track = [];
        $.each($(gpx).find("trkseg"), function(i, d) {
          $.each(d.children, function(i, d) {
            track.push({
              lat: $(d).attr("lat"),
              lon: $(d).attr("lon"),
              name: fname,
              ts: new Date($(d).find("time").text()) - starttime
            });
          });
        });
        tracks.push(track);
        checkdone();
      };
      reader.onerror = function(event) {
        alert("Load Error: " + event.target.error.code);
      };
      reader.readAsText(f);
    });
  });
});
</script>
<head>
<body class="ui-widget">

<h1>Compare GPX Files</h1>

<div id="upload">
GPX Files: <input type="file" id="gpxfiles" size="20" multiple><br>
<button id="load">Compare</button>
</div>

<div id="data">
<div id="slider"></div>
<div id="time"></div>
<div id="coords"></div>
</div>

</body>
</html>
